<!doctype html><html lang=en dir=ltr itemscope itemtype=https://schema.org/Article><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Microsoft Graph’s journey to HTTP/2</title>
<meta name=author content="Vincent Biret"><meta name=description content="For years Microsoft Graph has been serving billions of requests a day as one of the main REST APIs of Microsoft services. The service has become key infrastructure for Microsoft’s own applications,..."><meta name=generator content="Hugo 0.124.1"><meta itemprop=name content="Microsoft Graph’s journey to HTTP/2"><meta itemprop=description content="For years Microsoft Graph has been serving billions of requests a day as one of the main REST APIs of Microsoft services. The service has become key infrastructure for Microsoft’s own applications,..."><meta itemprop=image content="/img/logo.svg"><meta property="og:title" content="Microsoft Graph’s journey to HTTP/2"><meta property="og:type" content="article"><meta property="og:url" content="https://baywet.github.io/microsoft-graph-http2/"><meta property="og:image" content="/img/logo.svg"><meta property="og:description" content="For years Microsoft Graph has been serving billions of requests a day as one of the main REST APIs of Microsoft services. The service has become key infrastructure for Microsoft’s own applications,..."><meta property="og:site_name" content="Baywet's blog"><meta property="og:updated_time" content="2024-04-15T10:13:42-04:00"><meta property="article:published_time" content="2024-02-19T15:41:45+00:00"><meta property="article:modified_time" content="2024-04-15T10:13:42-04:00"><meta property="article:section" content><meta property="article:tag" content="http2"><meta property="article:tag" content="microsoft"><meta property="article:tag" content="graph"><meta property="article:tag" content="msgraph"><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:title content="Microsoft Graph’s journey to HTTP/2"><meta name=twitter:description content="For years Microsoft Graph has been serving billions of requests a day as one of the main REST APIs of Microsoft services. The service has become key infrastructure for Microsoft’s own applications,..."><meta name=twitter:creator content><meta name=twitter:image:src content="/img/logo.svg"><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.js integrity=sha384-IkmLcEDxkvCioiswmdraONwAU9uwbPWUbvuHAGrejK3zNlL74FCwCjvnTGJcrdbQ crossorigin=anonymous></script><link rel=stylesheet type=text/css href=/css/capsule.min.css><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-176061333-1","auto"),ga("send","pageview")</script><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link rel=icon href=/img/favicon.ico></head><body style=min-height:100vh;display:flex;flex-direction:column><nav class="navbar has-shadow is-white" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item href=/><div class="title is-4">&nbsp;Baywet's blog</div></a><label role=button class="navbar-burger has-text-dark" aria-label=menu aria-expanded=false for=navbar-burger-state><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></label></div><input type=checkbox id=navbar-burger-state><div class=navbar-menu><div class=navbar-end><a class=navbar-item href=https://baywet.github.io/fr/microsoft-graph-http2/>Français</a></div></div></div></nav><section class=section style=flex:1><div class=container><h1 class=title>Microsoft Graph’s journey to HTTP/2</h1><p class=subtitle>Feb 19, 2024</p><div class=content><p>For years Microsoft Graph has been serving billions of requests a day as one of the main REST APIs of Microsoft services. The service has become key infrastructure for Microsoft’s own applications, line of business solutions and third-party commercial solutions.</p><p>Any critical piece of infrastructure comes along with rigorous responsibilities: maintain, support, and secure. And sometimes this infrastructure needs to be “upgraded” to the latest standards which improve the value provided to its users through better safety, better interoperability, and better performance.</p><p>On the security front, the service team has deployed support for TLS1.2/1.3, as well as <a href=https://techcommunity.microsoft.com/t5/microsoft-sharepoint-blog/tls-1-0-and-1-1-deprecation/ba-p/1620264>disabled support for TLS1.0/1.1</a>. On the interoperability front, <a href=https://learn.microsoft.com/en-us/troubleshoot/azure/active-directory/azure-ad-ipv6-support>IPv6 has been enabled for Microsoft Graph a few months prior</a>. Both upgrades also helped lower latency.</p><p>Likewise, HTTP/2 (h2) helps lower latency, bandwidth usage (binary protocol, headers compression…) and enables better parallelism of multiple requests when compared with HTTP/1.1.</p><p>This is the story of how h2 was finally enabled for Microsoft Graph, a story of careful planning and collaboration.</p><h2 id=inception>Inception</h2><p>Back when I used to be a Microsoft MVP, I was already advocating to the then smaller product team to get h2 support. In fact, I believe that being vocal about this request is one of the reasons I’m on the team now, in a “stop complaining about this and come help us with it instead”. Of course, h2 always had a lower priority when compared with shipping additional features.</p><p>Fast forward to February 2022, I’m now working in the developer experience team (SDKs, tooling, etc.) and the service team is busy upgrading Microsoft Graph from dotnet “classic” to core. During the deployment of this new version, customers started to complain about older versions of the Java SDK breaking. This seemed odd as internal upgrades should not have any impact on the API surface itself.</p><p>It turns out that:</p><ul><li>h2 is enabled by default with asp.net core. (disabled in classic)</li><li>h2 normalizes headers to lower-kebab-case. (as opposed to Upper-Kebab-Case in HTTP/1.1)</li><li>these older Java SDK versions were using case sensitive comparisons to drive their logic.</li></ul><h2 id=planning>Planning</h2><p>After that initial experience with h2, the service team setup a validation platform with h2 enabled so we could test all SDKs’ readiness for h2 and patch the problematic SDKs.</p><p>This was even more pre-occupying due to the fact we didn’t have a way to properly measure the issue: the requests/responses were not failing, if any failure would occur, it’d be on the customers’ own infrastructure.</p><p>The service team then communicated an upcoming protocol change and give customers over a year to prepare for this change. Customers could either:</p><ul><li>Disable h2 via code or configuration. (less desired)</li><li>Check they were using “tested for h2” versions of the SDKs.</li><li>Check their code where it’s reading headers.</li></ul><h2 id=shipping>Shipping</h2><p>We initially had planned to start deploying h2 in September 2023, but had to delay to February 2024 due to the <a href=https://www.cisa.gov/news-events/alerts/2023/10/10/http2-rapid-reset-vulnerability-cve-2023-44487>Rapid Reset vulnerability discovered in some h2 server implementations</a>.</p><p>After gradual deployment of h2, the service team noticed some service instances hot while some would sit idle. This was caused by partition affinity at the load balancer level not accounting for the max parallel streams per connection which was promptly fixed.</p><p>H2 is finally fully deployed and the only thing you should have noticed is that “things feel a bit faster”. These protocol upgrades (h2, IPv6, TLS1.2+) keep our infrastructure working like clockwork.</p><p>We’re already looking at deploying HTTP3 which should yield even lower latency through its new QUIC layer!</p><p>I hope this kind of behind the curtails article was interesting to you, let me know what you thought of it in the comments!</p></div><br><p class=heading>Last edited
<a href=https://github.com/baywet/blogsource/commit/f9e991747e54c1ef20df74731781a7d829a3984e>Apr 15, 2024
</a>by <a href=https://github.com/baywet>Vincent Biret</a></p><br><div class=heading>Tags:</div><div class="field is-grouped is-grouped-multiline"><div class=control><a href=/tags/http2><span class=tag>Http2</span></a></div><div class=control><a href=/tags/microsoft><span class=tag>Microsoft</span></a></div><div class=control><a href=/tags/graph><span class=tag>Graph</span></a></div><div class=control><a href=/tags/msgraph><span class=tag>Msgraph</span></a></div></div></div></section><section class=section><div class=container><div class=level><div class=level-left><div class=level-item><p class="control has-addons"><a class=button href=# disabled><span class="icon is-small"><i class="fas fa-chevron-left"></i></span>
<span>Newest</span></a></p></div></div><div class=level-right><div class=level-item><p class="control has-addons"><a class=button href=https://baywet.github.io/installing-dotnet-sdk-wsl-ubuntu/><span class="is-hidden-touch is-hidden-desktop-only">Installing the dotnet SDK on Ubuntu under WSL
</span><span class="is-hidden-touch is-hidden-widescreen">Installing the dotnet SDK on Ubuntu under WSL
</span><span class="is-hidden-mobile is-hidden-desktop">Installing the dotnet SDK on Ubuntu under WSL
</span><span class=is-hidden-tablet>Installing the dotnet SDK on Ubuntu...
</span><span class="icon is-small"><i class="fas fa-chevron-right"></i></span></a></p></div></div></div></div><br><br><div class=container><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://baywet.github.io/microsoft-graph-http2/",this.page.identifier=window.location.pathname};(function(){var e=document,t=e.createElement("script");t.src="https://baywet.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><br><div class=container><nav class=panel><p class=panel-heading>Related</p><a class=panel-block href=https://baywet.github.io/shipping-kiota-microsoft/><span class="icon is-small"><i class="fas fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Shipping a product at Microsoft: Kiota&nbsp;<div class=tag>Microsoft</div></span></a><a class=panel-block href=https://baywet.github.io/one-year-developer/><span class="icon is-small"><i class="fas fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>One year as a Software Developer at Microsoft&nbsp;<div class=tag>Microsoft</div></span></a><a class=panel-block href=https://baywet.github.io/joining-microsoft-as-a-program/><span class="icon is-small"><i class="fas fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Joining Microsoft as a Program Manager on the Microsoft Graph&nbsp;<div class=tag>Microsoft</div></span></a><a class=panel-block href=https://baywet.github.io/re-awarded-microsoft-mvp-for-y/><span class="icon is-small"><i class="fas fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Re-awarded Microsoft MVP for year 2017 2018&nbsp;<div class=tag>Microsoft</div></span></a><a class=panel-block href=https://baywet.github.io/new-microsoft-conference-the-a/><span class="icon is-small"><i class="fas fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>New Microsoft Conference: the AzureCon&nbsp;<div class=tag>Microsoft</div></span></a></nav></div></section><footer class=footer><div class=container><nav class=level></nav><nav class=level><div class="level-left has-text-centered"><div class=level-item><form class="control has-icons has-icons-right" method=get action=https://bing.com><input class=input type=text name=q maxlength=255 placeholder=Search>
<input class=input type=hidden name=sites value=https://baywet.github.io/>
<span class="icon is-small is-right"><i class="fas fa-search"></i></span></form></div></div><div class="level-right has-text-centered"><div class=level-item><a class=button href=https://baywet.github.io/en><span class=icon><i class="fa fa-home"></i></span>
</a>&nbsp;
<a class=button href><span class=icon><i class="fas fa-rss"></i></span></a></div></div></nav></div></footer><script id=dsq-count-scr src=//baywet.disqus.com/count.js async></script></body></html>