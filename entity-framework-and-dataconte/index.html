<!doctype html><html lang=en dir=ltr itemscope itemtype=https://schema.org/Article><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Entity Framework and dataContext reference for a web application</title><meta name=author content="Vincent Biret"><meta name=description content="When using the entity framework with a data context we often have this problematic:
What’s the best between performance and simplicity of usage or scalability?
(no? you do not ask yourself that kind..."><meta name=generator content="Hugo 0.83.1"><meta itemprop=name content="Entity Framework and dataContext reference for a web application"><meta itemprop=description content="When using the entity framework with a data context we often have this problematic:
What’s the best between performance and simplicity of usage or scalability?
(no? you do not ask yourself that kind..."><meta itemprop=image content="/img/logo.svg"><meta property="og:title" content="Entity Framework and dataContext reference for a web application"><meta property="og:type" content="article"><meta property="og:url" content="https://baywet.github.io/entity-framework-and-dataconte/"><meta property="og:image" content="/img/logo.svg"><meta property="og:description" content="When using the entity framework with a data context we often have this problematic:
What’s the best between performance and simplicity of usage or scalability?
(no? you do not ask yourself that kind..."><meta property="og:site_name" content="Baywet's blog"><meta property="og:updated_time" content="2021-05-27T13:15:10+02:00"><meta property="article:published_time" content="2013-11-07T03:40:00+00:00"><meta property="article:modified_time" content="2021-05-27T13:15:10+02:00"><meta property="article:section" content><meta property="article:tag" content="entity framework"><meta property="article:tag" content="dev"><meta property="article:tag" content="developer"><meta property="article:tag" content="visual studio"><meta property="article:tag" content="c#"><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:title content="Entity Framework and dataContext reference for a web application"><meta name=twitter:description content="When using the entity framework with a data context we often have this problematic:
What’s the best between performance and simplicity of usage or scalability?
(no? you do not ask yourself that kind..."><meta name=twitter:creator content><meta name=twitter:image:src content="/img/logo.svg"><link rel=stylesheet type=text/css href=/css/capsule.min.css><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-176061333-1','auto'),ga('send','pageview')</script><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link rel=icon href=/img/favicon.ico></head><body style=min-height:100vh;display:flex;flex-direction:column><nav class="navbar has-shadow is-white" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item href=/en><div class="title is-4">&nbsp;Baywet's blog</div></a><label class="button navbar-burger is-white" for=navbar-burger-state><span></span><span></span><span></span></label></div><input type=checkbox id=navbar-burger-state><div class=navbar-menu><div class=navbar-end><a class=navbar-item href=https://baywet.github.io/fr/entity-framework-et-reference/>Français</a></div></div></div></nav><section class=section style=flex:1><div class=container><h1 class=title>Entity Framework and dataContext reference for a web application</h1><p class=subtitle>Nov 7, 2013</p><div class=content><p>When using the entity framework with a data context we often have this problematic:</p><p><strong>What’s the best between performance and simplicity of usage or scalability?</strong></p><p>(no? you do not ask yourself that kind of existential question?)</p><p>Here is a little explanation :</p><p><strong>Static instance</strong></p><p>In this first case you wrote a static reference to the context. Sometimes you also add some lazy loading and/or disposal management in global.asax (application end event)</p><p>It is efficient (understand fast) because the context is instantiated at the same time as the application domain (when app pool starts) or during the first call.</p><p>The instance will be destroyed during application end/stop (iis reset, pool reset, etc)</p><p>The advantage resides in the fact that, for each page request the model is already in memory. Entity Framework does not have to re scheme the model in memory and to check model and database integrity.</p><p>Another advantage is that you are working with a unique instance of the context all along page generation. Your objects are related to the context (no context rebinding, navigation properties available…)</p><p>The problem is this instance is shared across the application domain. Shared across all requests. This can be source of troubles when using transactions but the most important, it can be a bottleneck. Indeed, the Entity Framework is a APU (Applicative Persistence Unit) which does not (or does a very little of) pool database connections.</p><p>One instance = limited connection = thread waiting.</p><p><strong>Instance by call</strong></p><p>In that case, context is instantiated every time we need it and disposed as soon as possible. If we have a business layer, the context is instantiated in each service method. Most of a time a using (){} block is used.</p><p>The advantage is the application uses multiple context instances, so the application easily scales up.</p><p>The inconvenient is we are working with disconnected entities, we have to attach entities to the context. We also have to explicitly ask navigation properties loading (via .Include() method). Things are more complicated.</p><p><strong>Instance by Request</strong></p><p>The solution <a href="https://www.linkedin.com/profile/view?id=2248917" title="https://www.linkedin.com/profile/view?id=2248917">Brian Knoepfel</a> (coworker) and I found is the following one: instantiate one context for the request duration. So we benefit of the best of the two other solutions: simplicity, performances and scalability.</p><p>During Init we register an event which will be raised every time request handling ends.</p><p>Every time a new request is submitted, we instantiate a new entity framework context and store it into http context (unique to each request and in memory stored).</p><p>When we need the context we can access it via a simple helper.</p><p>During the end request event, we dispose the context avoiding potential memory leaks.</p><p>I hope this solution will help you building your applications. Do not hesitate to comment if you have a better one.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-CSharp data-lang=CSharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Global</span> : System.Web.HttpApplication
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> Init()
    {
        EndRequest += Global_EndRequest;
        <span style=color:#66d9ef>base</span>.Init();
    }

    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> Application_BeginRequest(<span style=color:#66d9ef>object</span> sender, EventArgs e)
    {
        HttpContext.Current.Items[<span style=color:#e6db74>&#34;EntityFrameworkContext&#34;</span>] = <span style=color:#66d9ef>new</span> AppEntitiesContext();
    }

    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> Global_EndRequest(<span style=color:#66d9ef>object</span> sender, EventArgs e)
    {
        BLL.ContextHelper.RequestContext.Dispose();
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ContextHelper</span>
    {
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> AppEntitiesContext RequestContext
        {
            <span style=color:#66d9ef>get</span>
            {
            <span style=color:#66d9ef>return</span> (AppEntitiesContext)HttpContext.Current.Items[<span style=color:#e6db74>&#34;EntityFrameworkContext&#34;</span>];
            }
        }
    }
}
</code></pre></div></div><br><p class=heading>Last edited
<a href=https://github.com/baywet/blogsource/commit/212285838725305ed7759bb19c2e84a4aafee591>May 27, 2021</a> by <a href=https://github.com/baywet>Vincent Biret</a></p><br><div class=heading>Tags:</div><div class="field is-grouped is-grouped-multiline"><div class=control><a href=/tags/entity-framework><span class=tag>Entity Framework</span></a></div><div class=control><a href=/tags/dev><span class=tag>Dev</span></a></div><div class=control><a href=/tags/developer><span class=tag>Developer</span></a></div><div class=control><a href=/tags/visual-studio><span class=tag>Visual Studio</span></a></div><div class=control><a href=/tags/c><span class=tag>C#</span></a></div></div></div></section><section class=section><div class=container><div class=level><div class=level-left><div class=level-item><p class="control has-addons"><a class=button href=https://baywet.github.io/sharepoint-auto-hosted-app-and/><span class="icon is-small"><i class="fa fa-chevron-left"></i></span>
<span class="is-hidden-touch is-hidden-desktop-only">SharePoint Auto hosted app and ASP.NET MVC</span>
<span class="is-hidden-touch is-hidden-widescreen">SharePoint Auto hosted app and ASP.NET MVC</span>
<span class="is-hidden-mobile is-hidden-desktop">SharePoint Auto hosted app and ASP.NET MVC</span>
<span class=is-hidden-tablet>SharePoint Auto hosted app and ASP.NET...</span></a></p></div></div><div class=level-right><div class=level-item><p class="control has-addons"><a class=button href=https://baywet.github.io/speaker-at-sharepoint-saturday/><span class="is-hidden-touch is-hidden-desktop-only">Speaker at SharePoint Saturday Ottawa!</span>
<span class="is-hidden-touch is-hidden-widescreen">Speaker at SharePoint Saturday Ottawa!</span>
<span class="is-hidden-mobile is-hidden-desktop">Speaker at SharePoint Saturday Ottawa!</span>
<span class=is-hidden-tablet>Speaker at SharePoint Saturday Ottawa!</span>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span></a></p></div></div></div></div><br><br><div class=container><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://baywet.github.io/entity-framework-and-dataconte/",this.page.identifier=window.location.pathname};(function(){var a=document,b=a.createElement('script');b.src='https://baywet.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><br></section><footer class=footer><div class=container><nav class=level></nav><nav class=level><div class="level-left has-text-centered"><div class=level-item><form class="control has-icons has-icons-right" method=get action=https://bing.com><input class=input type=text name=q maxlength=255 placeholder=Search>
<input class=input type=hidden name=sites value=https://baywet.github.io/>
<span class="icon is-small is-right"><i class="fa fa-search"></i></span></form></div></div><div class="level-right has-text-centered"><div class=level-item><a class=button href=https://baywet.github.io/en><span class=icon><i class="fa fa-home"></i></span></a> &nbsp;
<a class=button href><span class=icon><i class="fa fa-rss"></i></span></a></div></div></nav></div></footer><script id=dsq-count-scr src=//baywet.disqus.com/count.js async></script></body></html>