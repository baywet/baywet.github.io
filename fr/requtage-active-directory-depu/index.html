<!doctype html><html lang=fr dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Requêtage Active Directory depuis SharePoint.</title><meta name=author content><meta name=description content="Il arrive de nombreuses fois que l’on ait besoin d’envoyer des requêtes à l’Active Directory de la société dans SharePoint lors de développements.
Cependant il faut avoir quelques notions de «..."><meta name=generator content="Hugo 0.74.3"><meta itemprop=name content="Requêtage Active Directory depuis SharePoint."><meta itemprop=description content="Il arrive de nombreuses fois que l’on ait besoin d’envoyer des requêtes à l’Active Directory de la société dans SharePoint lors de développements.
Cependant il faut avoir quelques notions de «..."><meta itemprop=image content><meta property="og:title" content="Requêtage Active Directory depuis SharePoint."><meta property="og:type" content="article"><meta property="og:url" content="https://baywet.github.io/fr/requtage-active-directory-depu/"><meta property="og:image" content><meta property="og:description" content="Il arrive de nombreuses fois que l’on ait besoin d’envoyer des requêtes à l’Active Directory de la société dans SharePoint lors de développements.
Cependant il faut avoir quelques notions de «..."><meta property="og:site_name" content="Le blog de baywet"><meta property="article:published_time" content="2010-11-03T06:11:00+00:00"><meta property="article:section" content><meta property="article:tag" content="compte"><meta property="article:tag" content="privilèges"><meta property="article:tag" content="active directory"><meta property="article:tag" content="developpement"><meta property="article:tag" content="requète"><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:title content="Requêtage Active Directory depuis SharePoint."><meta name=twitter:description content="Il arrive de nombreuses fois que l’on ait besoin d’envoyer des requêtes à l’Active Directory de la société dans SharePoint lors de développements.
Cependant il faut avoir quelques notions de «..."><meta name=twitter:creator content><meta name=twitter:image:src content><link rel=stylesheet type=text/css href=/css/capsule.min.css></head><body style=min-height:100vh;display:flex;flex-direction:column><nav class="navbar has-shadow is-white" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item href=/fr><div class="title is-4">&nbsp;Le blog de baywet</div></a><label class="button navbar-burger is-white" for=navbar-burger-state><span></span><span></span><span></span></label></div><input type=checkbox id=navbar-burger-state><div class=navbar-menu><div class=navbar-end><a class=navbar-item href=/en>English</a></div></div></div></nav><section class=section style=flex:1><div class=container><p class=title>Requêtage Active Directory depuis SharePoint.</p><p class=subtitle>Nov 3, 2010</p><div class=content><p>Il arrive de nombreuses fois que l’on ait besoin d’envoyer des requêtes à l’Active Directory de la société dans SharePoint lors de développements.</p><p>Cependant il faut avoir quelques notions de « contexte d’exécution » car cela peut rapidement devenir un casse-tête le cas échéant.</p><p>Pour rappel, tout code .NET managé dans IIS est exécuté avec le compte de service aspnet qui a un minimum de privilèges.</p><p>Lorsque SharePoint doit effectuer des opérations nécessitant plus de droits il exécute du code en mode de privilèges élevés en utilisant ainsi le compte de service définit pour le pool de Web Application.</p><p>Une autre méthode pour augmenter les privilèges est d’utiliser l’impersonnification pour utiliser l’identité de l’utilisateur connecté.</p><p>Selon ce que vous êtes en train de réaliser et à quelle ressource vous accédez l’une ou l’autre méthode sera plus indiquée et plus sécurisée.</p><p>Autre information, les timerjobs sont exécutés par défaut avec le compte de service de l’OWS timer (le service). Ceci qui explique pourquoi vos requêtes vers l’active directory ont pu se passer sans problème dans un timerjob et pourquoi elles génèrent des erreurs quand elles sont émises depuis une application web. En effet le compte de l’OWS timer doit avoir un accès en lecture/écriture sur l’active directory.</p><p>Dans mes exemples je code un web service pour SharePoint qui sert à importer un utilisateur de l’active directory dans SharePoint à partir de son adresse e-mail et à lui rajouter des droits de lecture sur un document Word.</p><p>Le code n’est volontairement pas optimisé pour être le plus identique possible dans les trois exemples afin que vous remarquiez plus facilement les changements importants. Je vous conseille de copier/coller ce code dans visual studio pour plus de confort si vous souhaitez l’étudier en détails. <a href=https://baywet.github.io>Pour plus de clarté vous trouverez aussi en pièce jointe de cet article les trois fichiers de code bruts.</a></p><p>Premier exemple, la requête seule (que vous pourriez mettre dans un timer job normalement)</p><p>publicclass Classic : System.Web.Services.WebService</p><p>{</p><p>private string UMail, ULogon, UDName;</p><p>public void ChangeUserRights(Guid SiteID, Guid WebID, Guid ListID, Guid ItemID, string UserEmail, int RoleID)</p><p>{</p><p>using (SPSite site = new SPSite(SiteID))</p><p>{</p><p>using (SPWeb web = site.OpenWeb(WebID))</p><p>{</p><p>SPUser user;</p><p>try</p><p>{</p><p>user = web.SiteUsers.GetByEmail(UserEmail);</p><p>}</p><p>catch (SPException e)// On regarde juste si l&rsquo;utilisateur existe déjà, le cas échéant on l&rsquo;importe</p><p>{</p><p>try</p><p>{</p><p>UMail = UserEmail;</p><p>adgo();//on exécute le code de recherche de manière classique, mais cela risque de poser problème si on est pas dans un timerjob</p><p>web.SiteUsers.Add(ULogon, UserEmail, UDName, &ldquo;");//On ajoute notre utilisateur et le tour est joué</p><p>web.Update();</p><p>}</p><p>catch (DirectoryServicesCOMException f)</p><p>{</p><p>string ldapPath = f.Message.ToString();</p><p>}</p><p>user = web.SiteUsers.GetByEmail(UserEmail);</p><p>}</p><p>SPList list = web.Lists[ListID];// cette partie créé le role asignment pour donner le droit à l&rsquo;utilisateur sur le document</p><p>SPListItem item = list.Items[ItemID];</p><p>SPRoleDefinition RoleDefinition = web.RoleDefinitions[RoleID];</p><p>SPRoleAssignment RoleAssignment = new SPRoleAssignment(user.LoginName, user.Email, user.Name, string.Empty);</p><p>RoleAssignment.RoleDefinitionBindings.Add(RoleDefinition);</p><p>if (!item.HasUniqueRoleAssignments)</p><p>{</p><p>item.BreakRoleInheritance(true);</p><p>}</p><p>item.RoleAssignments.Add(RoleAssignment);</p><p>item.SystemUpdate();</p><p>}</p><p>}</p><p>}</p><p>private void adgo()</p><p>{</p><p>DirectoryEntry entry = newDirectoryEntry(&ldquo;LDAP://DC=toto,DC=com&rdquo;); //ouverture de connexion à l&rsquo;active directory</p><p>DirectorySearcherADSearcher = new DirectorySearcher(entry, &ldquo;(mail=&rdquo; + UMail + &ldquo;)&rdquo;, newstring[] { &ldquo;displayName&rdquo;, &ldquo;sAMAccountName&rdquo; }); //requête</p><p>SearchResult result = ADSearcher.FindOne(); //on ne veut qu&rsquo;un seul résultat</p><p>ULogon = Environment.UserDomainName + &ldquo;\&rdquo; + result.Properties[&ldquo;sAMAccountName&rdquo;][0]; //on récupère le logon et le displayname</p><p>UDName = result.Properties[&ldquo;displayName&rdquo;][0].ToString();</p><p>}</p><p>}</p><p>Second exemple, code exécuté en mode de privilèges élevés.</p><p>publicclass Elevated : System.Web.Services.WebService</p><p>{</p><p>private string UMail, ULogon, UDName;</p><p>public void ChangeUserRights(Guid SiteID, Guid WebID, Guid ListID, Guid ItemID, string UserEmail, int RoleID)</p><p>{</p><p>using (SPSite site = new SPSite(SiteID))</p><p>{</p><p>using (SPWeb web = site.OpenWeb(WebID))</p><p>{</p><p>SPUser user;</p><p>try</p><p>{</p><p>user = web.SiteUsers.GetByEmail(UserEmail);</p><p>}</p><p>catch (SPException e)</p><p>{</p><p>try</p><p>{</p><p>UMail = UserEmail;</p><p>SPSecurity.CodeToRunElevated thecode = new SPSecurity.CodeToRunElevated(adgo);</p><p>SPSecurity.RunWithElevatedPrivileges(thecode); //on exécute le code en privilèges élevés, le problème c&rsquo;est qu&rsquo;on ne peut pas passer d&rsquo;arguments à la méthode</p><p>web.SiteUsers.Add(ULogon, UserEmail, UDName, &ldquo;");</p><p>web.Update();</p><p>}</p><p>catch (DirectoryServicesCOMException f)</p><p>{</p><p>string ldapPath = f.Message.ToString();</p><p>}</p><p>user = web.SiteUsers.GetByEmail(UserEmail);</p><p>}</p><p>SPList list = web.Lists[ListID];</p><p>SPListItem item = list.Items[ItemID];</p><p>SPRoleDefinition RoleDefinition = web.RoleDefinitions[RoleID];</p><p>SPRoleAssignment RoleAssignment = new SPRoleAssignment(user.LoginName, user.Email, user.Name, string.Empty);</p><p>RoleAssignment.RoleDefinitionBindings.Add(RoleDefinition);</p><p>if (!item.HasUniqueRoleAssignments)</p><p>{</p><p>item.BreakRoleInheritance(true);</p><p>}</p><p>item.RoleAssignments.Add(RoleAssignment);</p><p>item.SystemUpdate();</p><p>}</p><p>}</p><p>}</p><p>private void adgo()</p><p>{</p><p>DirectoryEntry entry = new DirectoryEntry(&ldquo;LDAP://DC=toto,DC=com&rdquo;);</p><p>DirectorySearcher ADSearcher = new DirectorySearcher(entry, &ldquo;(mail=&rdquo; + UMail + &ldquo;)&rdquo;, newstring[] { &ldquo;displayName&rdquo;, &ldquo;sAMAccountName&rdquo; });</p><p>SearchResult result = ADSearcher.FindOne();</p><p>ULogon = Environment.UserDomainName + &ldquo;\&rdquo; + result.Properties[&ldquo;sAMAccountName&rdquo;][0];</p><p>UDName = result.Properties[&ldquo;displayName&rdquo;][0].ToString();</p><p>}</p><p>}</p><p>Et enfin le code de la méthode par impersonification.</p><p>publicclass Impersonate : System.Web.Services.WebService</p><p>{</p><p>private string UMail, ULogon, UDName;</p><p>public void ChangeUserRights(Guid SiteID, Guid WebID, Guid ListID, Guid ItemID, string UserEmail, int RoleID)</p><p>{</p><p>using (SPSite site = new SPSite(SiteID))</p><p>{</p><p>using (SPWeb web = site.OpenWeb(WebID))</p><p>{</p><p>SPUser user;</p><p>try</p><p>{</p><p>user = web.SiteUsers.GetByEmail(UserEmail);</p><p>}</p><p>catch (SPException e)</p><p>{</p><p>try</p><p>{</p><p>UMail = UserEmail;</p><p>System.Security.Principal.WindowsImpersonationContext impersonationContext;//on récupère l&rsquo;identité de l&rsquo;utilisateur connecté</p><p>impersonationContext = ((System.Security.Principal.WindowsIdentity)User.Identity).Impersonate(); //on passe l&rsquo;exécution du code avec son identité</p><p>adgo();</p><p>impersonationContext.Undo(); //fin de la portion de code avec son identité</p><p>web.SiteUsers.Add(ULogon, UserEmail, UDName, &ldquo;");</p><p>web.Update();</p><p>}</p><p>catch (DirectoryServicesCOMException f)</p><p>{</p><p>string ldapPath = f.Message.ToString();</p><p>}</p><p>user = web.SiteUsers.GetByEmail(UserEmail);</p><p>}</p><p>SPList list = web.Lists[ListID];</p><p>SPListItem item = list.Items[ItemID];</p><p>SPRoleDefinition RoleDefinition = web.RoleDefinitions[RoleID];</p><p>SPRoleAssignment RoleAssignment = new SPRoleAssignment(user.LoginName, user.Email, user.Name, string.Empty);</p><p>RoleAssignment.RoleDefinitionBindings.Add(RoleDefinition);</p><p>if (!item.HasUniqueRoleAssignments)</p><p>{</p><p>item.BreakRoleInheritance(true);</p><p>}</p><p>item.RoleAssignments.Add(RoleAssignment);</p><p>item.SystemUpdate();</p><p>}</p><p>}</p><p>}</p><p>private void adgo()</p><p>{</p><p>DirectoryEntry entry = new DirectoryEntry(&ldquo;LDAP://DC=toto,DC=com&rdquo;);</p><p>DirectorySearcher ADSearcher = new DirectorySearcher(entry, &ldquo;(mail=&rdquo; + UMail + &ldquo;)&rdquo;, newstring[] { &ldquo;displayName&rdquo;, &ldquo;sAMAccountName&rdquo; });</p><p>SearchResult result = ADSearcher.FindOne();</p><p>ULogon = Environment.UserDomainName + &ldquo;\&rdquo; + result.Properties[&ldquo;sAMAccountName&rdquo;][0];</p><p>UDName = result.Properties[&ldquo;displayName&rdquo;][0].ToString();</p><p>}</p><p>}</p><p>Notez bien que ces trois méthodes fonctionnent, tout dépend du contexte d’exécution à chaque fois, il vous appartient de choisir la méthode qui convient le mieux. Classique pour timer jobs, élevée pour des applications accessibles à des utilisateurs qui n’ont pas accès à l’AD mais qui doivent quand même pouvoir lire des informations dedans, et impersonnifiée pour coller aux droits de l’AD.</p><p>Autre chose, l’assembly qui permet d’envoyer des requêtes à Active Directory est <a href=https://msdn.microsoft.com/fr-fr/library/system.directoryservices%28VS.90%29.aspx>System.DirectoryServices</a></p><p>Vous savez tout désormais, n’hésitez pas à laisser des commentaires ou à me contacter si vous avez des questions/remarques/suggestions.</p></div><br><div class=heading>Tags:</div><div class="field is-grouped is-grouped-multiline"><div class=control><a href=/fr/tags/compte><span class=tag>Compte</span></a></div><div class=control><a href=/fr/tags/privil%c3%a8ges><span class=tag>Privilèges</span></a></div><div class=control><a href=/fr/tags/active-directory><span class=tag>Active Directory</span></a></div><div class=control><a href=/fr/tags/developpement><span class=tag>Developpement</span></a></div><div class=control><a href=/fr/tags/requ%c3%a8te><span class=tag>Requète</span></a></div><div class=control><a href=/fr/tags/sharepoint><span class=tag>Sharepoint</span></a></div></div></div></section><section class=section><div class=container><div class=level><div class=level-left><div class=level-item><p class="control has-addons"><a class=button href=https://baywet.github.io/fr/gagnez-des-packs-kinect-avec-e/><span class="icon is-small"><i class="fa fa-chevron-left"></i></span><span class="is-hidden-touch is-hidden-desktop-only">Gagnez des packs Kinect avec Etudiants.ms</span>
<span class="is-hidden-touch is-hidden-widescreen">Gagnez des packs Kinect avec Etudiants.ms</span>
<span class="is-hidden-mobile is-hidden-desktop">Gagnez des packs Kinect avec Etudiants.ms</span>
<span class=is-hidden-tablet>Gagnez des packs Kinect avec...</span></a></p></div></div><div class=level-right><div class=level-item><p class="control has-addons"><a class=button href=https://baywet.github.io/fr/convertir-proprement-des-docum/><span class="is-hidden-touch is-hidden-desktop-only">Convertir proprement des documents Word en HTML</span>
<span class="is-hidden-touch is-hidden-widescreen">Convertir proprement des documents Word en HTML</span>
<span class="is-hidden-mobile is-hidden-desktop">Convertir proprement des documents Word en HTML</span>
<span class=is-hidden-tablet>Convertir proprement des documents Word...</span>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span></a></p></div></div></div></div><br><br><div class=container><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://baywet.github.io/fr/requtage-active-directory-depu/";this.page.identifier=window.location.pathname;};(function(){var d=document,s=d.createElement('script');s.src='https://baywet.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><br><div class=container><nav class=panel><p class=panel-heading>Related</p><a class=panel-block href=https://baywet.github.io/fr/convertir-proprement-des-docum/><span class="icon is-small"><i class="fa fa-chevron-right"></i></span><span>&nbsp;</span>
<span>Convertir proprement des documents Word en HTML&nbsp;<div class=tag>Developpement</div></span></a><a class=panel-block href=https://baywet.github.io/fr/feedback-msday-aix-en-provence/><span class="icon is-small"><i class="fa fa-chevron-right"></i></span><span>&nbsp;</span>
<span>Feedback MSDay Aix-En-Provence 30/09/10&nbsp;<div class=tag>Sharepoint</div></span></a><a class=panel-block href=https://baywet.github.io/fr/ajouter-un-nouvel-administrate/><span class="icon is-small"><i class="fa fa-chevron-right"></i></span><span>&nbsp;</span>
<span>Ajouter un nouvel administrateur de ferme SharePoint pouvant éxécuter la console PowerShell sans encombres&nbsp;<div class=tag>Sharepoint</div></span></a><a class=panel-block href=https://baywet.github.io/fr/configuration-du-service-profi/><span class="icon is-small"><i class="fa fa-chevron-right"></i></span><span>&nbsp;</span>
<span>Configuration du service profil utilisateur sous SharePoint 2010/2007&nbsp;<div class=tag>Sharepoint</div></span></a></nav></div></section><footer class=footer><div class=container><nav class=level></nav><nav class=level><div class="level-left has-text-centered"><div class=level-item><form class="control has-icons has-icons-right" method=get action=https://duckduckgo.com><input class=input type=text name=q maxlength=255 placeholder=Search>
<input class=input type=hidden name=sites value=https://baywet.github.io/>
<span class="icon is-small is-right"><i class="fa fa-search"></i></span></form></div></div><div class="level-right has-text-centered"><div class=level-item><a class=button href=https://baywet.github.io/><span class=icon><i class="fa fa-home"></i></span></a>&nbsp;
<a class=button href><span class=icon><i class="fa fa-rss"></i></span></a></div></div></nav></div></footer><script id=dsq-count-scr src=//baywet.disqus.com/count.js async></script></body></html>