<!doctype html><html lang=fr dir=ltr itemscope itemtype=https://schema.org/Article>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Service de Cache distribué de SharePoint 2013 – SPDistributedCacheService – comment ne pas se manger ?</title>
<meta name=author content="Vincent Biret">
<meta name=description content="On a tous eu des soucis de provisionnement de service de synchronisation de profil utilisateur avec SharePoint 2010 avant le SP1. Service qui ne démarre pas, service bloqué en démarrage, problèmes de...">
<meta name=generator content="Hugo 0.88.1">
<meta itemprop=name content="Service de Cache distribué de SharePoint 2013 – SPDistributedCacheService – comment ne pas se manger ?">
<meta itemprop=description content="On a tous eu des soucis de provisionnement de service de synchronisation de profil utilisateur avec SharePoint 2010 avant le SP1. Service qui ne démarre pas, service bloqué en démarrage, problèmes de...">
<meta itemprop=image content="/img/logo.svg">
<meta property="og:title" content="Service de Cache distribué de SharePoint 2013 – SPDistributedCacheService – comment ne pas se manger ?">
<meta property="og:type" content="article">
<meta property="og:url" content="https://baywet.github.io/fr/service-de-cache-distribue-de/">
<meta property="og:image" content="/img/logo.svg">
<meta property="og:description" content="On a tous eu des soucis de provisionnement de service de synchronisation de profil utilisateur avec SharePoint 2010 avant le SP1. Service qui ne démarre pas, service bloqué en démarrage, problèmes de...">
<meta property="og:site_name" content="Le blog de baywet">
<meta property="og:updated_time" content="2021-10-18T07:18:56-04:00">
<meta property="article:published_time" content="2012-12-22T02:46:07+00:00">
<meta property="article:modified_time" content="2021-10-18T07:18:56-04:00">
<meta property="article:section" content>
<meta property="article:tag" content="2013">
<meta property="article:tag" content="distribué">
<meta property="article:tag" content="cache">
<meta property="article:tag" content="tips">
<meta property="article:tag" content="configuration">
<meta name=twitter:card content="summary">
<meta name=twitter:site content>
<meta name=twitter:title content="Service de Cache distribué de SharePoint 2013 – SPDistributedCacheService – comment ne pas se manger ?">
<meta name=twitter:description content="On a tous eu des soucis de provisionnement de service de synchronisation de profil utilisateur avec SharePoint 2010 avant le SP1. Service qui ne démarre pas, service bloqué en démarrage, problèmes de...">
<meta name=twitter:creator content>
<meta name=twitter:image:src content="/img/logo.svg">
<link rel=stylesheet type=text/css href=/css/capsule.min.css>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-176061333-1','auto'),ga('send','pageview')</script>
<link rel=apple-touch-icon href=/img/apple-touch-icon.png>
<link rel=icon href=/img/favicon.ico>
</head>
<body style=min-height:100vh;display:flex;flex-direction:column>
<nav class="navbar has-shadow is-white" role=navigation aria-label="main navigation">
<div class=container>
<div class=navbar-brand>
<a class=navbar-item href=/fr>
<div class="title is-4">&nbsp;Le blog de baywet</div>
</a>
<label class="button navbar-burger is-white" for=navbar-burger-state>
<span></span>
<span></span>
<span></span>
</label>
</div>
<input type=checkbox id=navbar-burger-state>
<div class=navbar-menu>
<div class=navbar-end>
<a class=navbar-item href=/en>English</a>
</div>
</div>
</div>
</nav>
<section class=section style=flex:1>
<div class=container>
<h1 class=title>Service de Cache distribué de SharePoint 2013 – SPDistributedCacheService – comment ne pas se manger ?</h1>
<p class=subtitle>Dec 22, 2012</p>
<div class=content>
<p>On a tous eu des soucis de provisionnement de service de synchronisation de profil utilisateur avec SharePoint 2010 avant le SP1. Service qui ne démarre pas, service bloqué en démarrage, problèmes de permissions…</p>
<p>Avec SharePoint 2013 arrive le service de cache distribué aka AppFabric Cache service. Ce service sert à, comme son nom l’indique, faire de la mise en cache pour améliorer les performances de SharePoint 2013.</p>
<p>Qu’est-ce qui est mise en cache ? Des jetons de sécurité, des contextes de sécurité, des données de session, des objets SharePoint, et le plus important, des données sociales (flux d’information & co).</p>
<p>Plus de détails <a href=https://technet.microsoft.com/library/jj219700%28office.15%29.aspx>https://technet.microsoft.com/library/jj219700(office.15).aspx</a></p>
<p>Vous comprendrez donc que son bon fonctionnement conditionne fortement celui des nouvelles fonctionnalités sociales apportées par SharePoint 2013.</p>
<p>Récemment j’ai procédé à l’installation d’une ferme de production sous SharePoint 2013 et je me suis cassé les dents sur la mise en place des fonctionnalités sociales et du service de cache. En effet c’est nouveau, peu documenté, pas beaucoup de retour d’expérience. J’ai fini par faire appel au support Microsoft, mon ticket et monté jusqu’au niveau 3, le problème n’était donc pas simple à la base. L’objectif de cet article est donc de faire un retour d’expérience afin de vous éviter les écueils et de donner quelques conseils sur comment gérer ce nouveau service, les impacts en termes de topologie.</p>
<p>Nous allons commencer par des questions de topologie, en effet où faut-il disposer ce nouveau service pour obtenir les meilleures performances ? Microsoft répond ceci, nous avons quatre solutions :</p>
<ul>
<li>
<p>Dans le cadre d’une installation complète sur un seul serveur SharePoint (toute la ferme sur une machine), la réponse est assez simple, sur la même machine.</p>
</li>
<li>
<p>Dans le cadre d’une ferme plus complète, sur tous les serveurs</p>
</li>
<li>
<p>Dans le cadre d’une ferme importante, sur les serveurs web frontaux</p>
</li>
<li>
<p>Dans le cadre d’une ferme de grande taille, sur des serveurs dédiés</p>
</li>
</ul>
<p>Voir la vidéo sur le cache ici, très instructive <a href=https://technet.microsoft.com/en-us/sharepoint/fp123606.aspx>https://technet.microsoft.com/en-us/sharepoint/fp123606.aspx</a></p>
<p>Note : lors de mon case, j’ai eu aussi des ingénieurs support niveau 2 appfabric, eux recommandent directement un serveur dédié au cache (ou plusieurs), dès le second type de ferme pour des questions de performance.</p>
<p>Mais voilà il y a quelques « détails » à savoir :</p>
<ul>
<li>
<p>Il est très fortement déconseillé d’avoir plus de 5 serveurs de cache par ferme.</p>
</li>
<li>
<p>Il est très fortement déconseillé d’exécuter le service de cache sur une machine faisant tourner les services de synchronisation de profil utilisateur et/ou de recherche.</p>
</li>
<li>
<p>La mémoire dynamique est très fortement déconseillée (dans le cadre de machines virtuelles)</p>
</li>
<li>
<p>La mémoire allouée au service de cache doit être la même sur tous les nœuds du cluster de cache.</p>
</li>
<li>
<p>La mémoire alloué au service ne doit pas excéder 16Go.</p>
</li>
<li>
<p>Si à un moment donné l’utilisation mémoire de la machine dépasse les 90%, le service de cache se met en mode de purge, il n’accepte plus aucun objet et essaie d’en vider un maximum jusqu’à atteindre les 70% causant une dégradation importante des performances.</p>
</li>
<li>
<p>SharePoint 2013 utilise (et embarque) App Fabric 1.1, qui est la seule version supportée même si elle est vieille, il est formellement interdit de procéder à une mise à jour manuelle du composant (ou sinon perte du support Microsoft).</p>
</li>
</ul>
<p>Une liste plus exhaustive de ces détails est disponible ici <a href=https://technet.microsoft.com/library/jj219572%28office.15%29.aspx>https://technet.microsoft.com/library/jj219572(office.15).aspx</a></p>
<p>Le service de cache fonctionne par nature en cluster, en effet son premier rôle est de mettre des objets en mémoire lors du premier accès (ou lors d’une phase de chargement initiale) afin de permettre un accès plus rapide par la suite. Il sert aussi à faire transiter les objets (notamment de session) entre les divers serveurs. De plus il apporte une certaine tolérance à la panne.</p>
<p>Votre cluster est donc constitué d’un ou plusieurs services de cache. Ce service de cache est provisionné et démarré par défaut par le psconfig (assistant de configuration des produits et technologies SharePoint). Vous avez la possibilité d’indiquer au psconfig de ne pas provisionner ce service avec une option. Voir <a href=https://sharepointinterview.com/sharepoint-2013-preview-setup-and-configuration-error-with-appfabric-cache/>https://sharepointinterview.com/sharepoint-2013-preview-setup-and-configuration-error-with-appfabric-cache/</a></p>
<p>Si le service est dans l’état arrêté, il est effectivement arrêté mais il fait toujours partie du cluster de cache et peut éventuellement perturber son bon fonctionnement.</p>
<p>Pour l’arrêter et le dé provisionner correctement, il faut utiliser les commandes powershell suivantes :</p>
<p>Stop-SPDistributedCacheServiceInstance -Graceful</p>
<p>Remove-SPDistributedCacheServiceInstance</p>
<p>Il est très important de faire le stop graceful avant le remove, car sinon votre cluster se retrouvera dans un état inconsistant et bloqué.</p>
<p>Plus de documentation sur comment gérer le service de cache ici <a href=https://technet.microsoft.com/library/jj219613%28office.15%29.aspx>https://technet.microsoft.com/library/jj219613(office.15).aspx</a></p>
<p>Quelques autres commandes très utiles :</p>
<p>(Lancer la console SharePoint en mode admin avant et entrer use-cachecluter)</p>
<p>get-cacheclusterhealth qui vous permet de connaitre la santé du cluster de cache (s’il y a des fragments, ce n’est pas bon signe) <a href="https://msdn.microsoft.com/en-us/library/ff428190%28v=azure.10%29.aspx">https://msdn.microsoft.com/en-us/library/ff428190(v=azure.10).aspx</a></p>
<p>Restart-cachecluster qui redémarre tous les services de cache composant le cluster et force une reconstruction complète du cache <a href="https://msdn.microsoft.com/en-us/library/ff428182%28v=azure.10%29.aspx">https://msdn.microsoft.com/en-us/library/ff428182(v=azure.10).aspx</a></p>
<p>Pour ce qui est des droits, ce service n’a pas besoin de droits particuliers sur la machine, il suffit que le compte de service qui le provisionne soit admin de la machine, son compte de service doit aussi avoir le contrôle total de l’application de service profil utilisateur.</p>
<p>Pour que votre newsfeed fonctionne correctement, car c’est quand même le but recherché, il faut que :</p>
<ul>
<li>
<p>Votre recherche soit configurée avec la recherche continue (continous crawl), merci au user group sharepoint Montréal pour l’information.</p>
</li>
<li>
<p>Votre service profil utilisateur soit correctement configuré.</p>
</li>
<li>
<p>Compte de service du cache ayant le contrôle total sur l’application de service profil utilisateur.</p>
</li>
<li>
<p>Compte de service de l’application web qui héberge la collection de site « mon site » ait le contrôle total de l’application se service profil utilisateur.</p>
</li>
<li>
<p>Les comptes suivants aient le droit d’accéder au service de cache :</p>
</li>
<li>
<p>Compte de service de recherche</p>
</li>
<li>
<p>Compte de service profil utilisateur</p>
</li>
<li>
<p>Compte de la ferme</p>
</li>
<li>
<p>Compte de l’application web qui héberge le mysite</p>
</li>
</ul>
<p>Vous pouvez donner ces permissions sur le cluster de cache grâce à la commande Grant-CacheAllowedClientAccount <a href="https://msdn.microsoft.com/en-us/library/ff428172%28v=azure.10%29.aspx">https://msdn.microsoft.com/en-us/library/ff428172(v=azure.10).aspx</a></p>
<p>Enfin la commande Export-CacheClusterConfig vous permettra de savoir quelle est la configuration actuelle du cluster de cache <a href="https://msdn.microsoft.com/en-us/library/ff428173%28v=azure.10%29.aspx">https://msdn.microsoft.com/en-us/library/ff428173(v=azure.10).aspx</a></p>
<p>Dernière précision, ce service ne vient pas remplacer les mécanismes déjà connus de cache de sortie, cache objet, et blobcache.</p>
<p>Voilà c’est globalement tout ce que j’avais à dire sur ce service de cache, sur les impacts aux topologies, les écueils à éviter etc. J’espère que cela vous aura aidé à mieux apprivoiser ce nouveau service et vous aura fait gagner du temps.</p>
<p>Merci aux membres des communautés, staff AlphaMosaïk et ingénieurs de support Microsoft sui m’ont aidé sur ce problème.</p>
</div>
<br>
<p class=heading>
Edité la dernière fois le
<a href=https://github.com/baywet/blogsource/commit/2ece8ee71416fd7fc596b68f611c178059703575>
18 Oct 2021
</a> par <a href=https://github.com/baywet>Vincent Biret</a>
</p>
<br>
<div class=heading>Tags:</div>
<div class="field is-grouped is-grouped-multiline">
<div class=control>
<a href=/fr/tags/2013>
<span class=tag>2013th</span>
</a>
</div>
<div class=control>
<a href=/fr/tags/distribu%c3%a9>
<span class=tag>Distribué</span>
</a>
</div>
<div class=control>
<a href=/fr/tags/cache>
<span class=tag>Cache</span>
</a>
</div>
<div class=control>
<a href=/fr/tags/tips>
<span class=tag>Tips</span>
</a>
</div>
<div class=control>
<a href=/fr/tags/configuration>
<span class=tag>Configuration</span>
</a>
</div>
<div class=control>
<a href=/fr/tags/sharepoint>
<span class=tag>Sharepoint</span>
</a>
</div>
</div>
</div>
</section>
<section class=section>
<div class=container>
<div class=level>
<div class=level-left>
<div class=level-item>
<p class="control has-addons">
<a class=button href=https://baywet.github.io/fr/conferences-a-venir-en-2013/>
<span class="icon is-small"><i class="fa fa-chevron-left"></i></span>
<span class="is-hidden-touch is-hidden-desktop-only">
Conférences à venir en 2013
</span>
<span class="is-hidden-touch is-hidden-widescreen">
Conférences à venir en 2013
</span>
<span class="is-hidden-mobile is-hidden-desktop">
Conférences à venir en 2013
</span>
<span class=is-hidden-tablet>
Conférences à venir en 2013
</span>
</a>
</p>
</div>
</div>
<div class=level-right>
<div class=level-item>
<p class="control has-addons">
<a class=button href=https://baywet.github.io/fr/configuration-de-la-topologie/>
<span class="is-hidden-touch is-hidden-desktop-only">
Configuration de la topologie de recherche d’entreprise dans SharePoint 2013
</span>
<span class="is-hidden-touch is-hidden-widescreen">
Configuration de la topologie de recherche d’entreprise dans SharePoint...
</span>
<span class="is-hidden-mobile is-hidden-desktop">
Configuration de la topologie de recherche...
</span>
<span class=is-hidden-tablet>
Configuration de la topologie de...
</span>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
</a>
</p>
</div>
</div>
</div>
</div>
<br>
<br>
<div class=container>
<div id=disqus_thread></div>
<script>var disqus_config=function(){this.page.url="https://baywet.github.io/fr/service-de-cache-distribue-de/",this.page.identifier=window.location.pathname};(function(){var a=document,b=a.createElement('script');b.src='https://baywet.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
</div>
<br>
<div class=container>
<nav class=panel>
<p class=panel-heading>Related</p>
<a class=panel-block href=https://baywet.github.io/fr/configuration-de-la-topologie/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Configuration de la topologie de recherche d’entreprise dans SharePoint 2013&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/itemupdating-et-itemupdated-le/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>ItemUpdating et ItemUpdated levé deux fois dans des SPDocuementLibrary&nbsp;
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/les-joies-de-spitemeventproper/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Les joies de SPItemEventProperties.AfterProperties&nbsp;
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/upgrade-sharepoint-2013-sche/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Upgrade SharePoint 2013 - Schemas&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/sharepoint-2013-rtm-disponible/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>SharePoint 2013 RTM disponible pour les abonnés MSDN!&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/fldtype-custom-field-qui-ne-s/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Fldtype / custom field qui ne s’affiche pas dans la liste des colonnes de la liste (paramètres) après ajout.&nbsp;
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/traduire-sharepoint-2013/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Traduire SharePoint 2013&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/sharepoint-2013-beta-failed-t/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>SharePoint 2013 beta – failed to open sms.resx&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/warmmeup-warmup-sharepoint-20/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>WarmMeUp – WarmUp SharePoint 2013 (et 2010)&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/sharepoint-2013-app-et-wsp/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>SharePoint 2013 App et WSP&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/sharepoint-2013-et-les-workflo/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>SharePoint 2013 et les workflows - nouveautés&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/sortie-de-la-preview-publique/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Sortie de la Preview publique de SharePoint 2013&nbsp;
<div class=tag>2013th</div>
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/les-outils-de-developpement-po/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Les outils de développement pour SharePoint dans Visual Studio 2012&nbsp;
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/creer-des-librairies-pour-les/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>Créer des librairies pour les projets SharePoint&nbsp;
<div class=tag>Sharepoint</div>
</span>
</a>
<a class=panel-block href=https://baywet.github.io/fr/sharepoint-auto-upgrade-soluti/>
<span class="icon is-small"><i class="fa fa-chevron-right"></i></span>
<span>&nbsp;</span>
<span>SharePoint Auto Upgrade Solution&nbsp;
<div class=tag>Sharepoint</div>
</span>
</a>
</nav>
</div>
</section>
<footer class=footer>
<div class=container>
<nav class=level>
</nav>
<nav class=level>
<div class="level-left has-text-centered">
<div class=level-item>
<form class="control has-icons has-icons-right" method=get action=https://bing.com>
<input class=input type=text name=q maxlength=255 placeholder=Search>
<input class=input type=hidden name=sites value=https://baywet.github.io/>
<span class="icon is-small is-right"><i class="fa fa-search"></i></span>
</form>
</div>
</div>
<div class="level-right has-text-centered">
<div class=level-item>
<a class=button href=https://baywet.github.io/fr>
<span class=icon><i class="fa fa-home"></i></span>
</a> &nbsp;
<a class=button href>
<span class=icon><i class="fa fa-rss"></i></span>
</a>
</div>
</div>
</nav>
</div>
</footer>
<script id=dsq-count-scr src=//baywet.disqus.com/count.js async></script>
</body>
</html>